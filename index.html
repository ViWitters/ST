<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algen Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div id="background"></div>

    <div class="container">
        <div class="box">

            <div class="grid">
                <div class="cell left">üå°Ô∏è Temperatuur</div>
                <div class="cell v-divider"></div>
                <div class="cell right">üíß NTU</div>

                <div class="h-divider"></div>

                <div class="cell left value" id="tempValue">-- ¬∞C</div>
                <div class="cell v-divider"></div>
                <div class="cell right value" id="ntuValue">-- NTU</div>
            </div>

            <div class="h-divider"></div>

            <div class="footer" id="lastUpdate">
                Laatste update: --
            </div>

            <canvas id="tempChart"></canvas>

        </div>
    </div>

    <!-- SCRIPT 1: Grafiek aanmaken -->
    <script>
        const ctx = document.getElementById('tempChart').getContext('2d');

        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperatuur (¬∞C)',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        tension: 0.3,
                        spanGaps: true,
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        yAxisID: 'yLeft'
                    },
                    {
                        label: 'NTU',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        tension: 0.3,
                        spanGaps: true,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        yAxisID: 'yRight'
                    }
                ]
            },
            options: {
                responsive: true,
                elements: {
                    line: {
                        spanGaps: true
                    },
                    point: {
                        radius: 4,
                        hoverRadius: 6
                    }
                },
                scales: {
                    yLeft: {
                        min: 0,
                        max: 30,
                        position: 'left'
                    },
                    yRight: {
                        min: 0,
                        max: 20,
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    </script>

    <!-- SCRIPT 2: ThingSpeak data ophalen -->
    <script>
        async function loadData() {

          function toLocalTimeLabel(isoString) {
    const d = new Date(isoString);
    return d.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
}

function toLocalDateTime(isoString) {
    const d = new Date(isoString);
    return d.toLocaleString('nl-BE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

            const url = "https://api.thingspeak.com/channels/3243838/feeds.json?results=50";

            const response = await fetch(url);
            const data = await response.json();
            const feeds = data.feeds;

            // Kies de meest recente 10 invoeren waar beide velden aanwezig zijn (valt terug op enige veld als er niet genoeg zijn)
            let dataFeeds = feeds.filter(f => f.field1 !== null && f.field2 !== null);
            if (dataFeeds.length < 10) {
                dataFeeds = feeds.filter(f => f.field1 !== null || f.field2 !== null);
            }
            dataFeeds = dataFeeds.slice(-10);

            // Labels en waarden opbouwen uit de geselecteerde feeds
            const tempLabels = dataFeeds.map(f => toLocalTimeLabel(f.created_at));
            const tempValues = dataFeeds.map(f => f.field1 !== null ? parseFloat(f.field1) : null);
            const ntuValues = dataFeeds.map(f => f.field2 !== null ? parseFloat(f.field2) : null);

            // Grafiek updaten
            tempChart.data.labels = tempLabels;
            tempChart.data.datasets[0].data = tempValues;
            tempChart.data.datasets[1].data = ntuValues;
            tempChart.update();

            // Laatste waarden bovenaan tonen
            // Zoek laatste niet-lege temperatuurwaarde in tempValues
            let lastTemp = null;
            for (let i = tempValues.length - 1; i >= 0; i--) {
                if (tempValues[i] !== null && !isNaN(tempValues[i])) {
                    lastTemp = tempValues[i];
                    break;
                }
            }
            if (lastTemp !== null) {
                document.getElementById("tempValue").textContent = lastTemp + " ¬∞C";
            } else {
                document.getElementById("tempValue").textContent = "-- ¬∞C";
            }

            // Zoek laatste niet-lege NTU-waarde in ntuValues
            let lastNtu = null;
            for (let i = ntuValues.length - 1; i >= 0; i--) {
                if (ntuValues[i] !== null && !isNaN(ntuValues[i])) {
                    lastNtu = ntuValues[i];
                    break;
                }
            }
            if (lastNtu !== null) {
                document.getElementById("ntuValue").textContent = lastNtu + " NTU";
            } else {
                document.getElementById("ntuValue").textContent = "-- NTU";
            }

            // Laatste update tijd (gebruik laatste van de geselecteerde dataFeeds indien mogelijk)
            const lastValid = (typeof dataFeeds !== 'undefined' && dataFeeds.length > 0)
                ? dataFeeds[dataFeeds.length - 1].created_at
                : feeds[feeds.length - 1].created_at;
            document.getElementById("lastUpdate").textContent =
                "Laatste update: " + toLocalDateTime(lastValid);
        }

        loadData();
        setInterval(loadData, 30000);
    </script>

</body>
</html>
